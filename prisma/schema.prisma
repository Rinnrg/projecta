generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  GURU
  SISWA
}

enum TipeAsesmen {
  KUIS
  TUGAS
}

enum TipePengerjaan {
  INDIVIDU
  KELOMPOK
}

enum TipeJawaban {
  PILIHAN_GANDA
  ISIAN
}

model User {
  id        String   @id @default(uuid())
  username  String?  @unique
  email     String   @unique
  nama      String
  password  String?
  role      Role     @default(SISWA)
  foto      String?
  kelas     String?  // Kelas untuk siswa
  createdAt DateTime @default(now())

  course        Course[]
  proyekDibuat  Proyek[]
  asesmenDibuat Asesmen[]

  nilai           Nilai[]
  anggotaKelompok AnggotaKelompok[]
  profileShowcase ProfileShowcase[]
  enrollments     Enrollment[]
  pengumpulanProyek PengumpulanProyek[] // For individual task submissions
  jawabanSiswa    JawabanSiswa[]
}

model Course {
  id       String @id @default(cuid())
  judul    String
  gambar   String
  kategori String

  guruId String
  guru   User   @relation(fields: [guruId], references: [id])

  asesmen     Asesmen[]
  materi      Materi[]
  enrollments Enrollment[]

  @@index([guruId])
  @@index([kategori])
}

model Materi {
  id         String   @id @default(cuid())
  judul      String
  deskripsi  String?  @db.Text
  tgl_unggah DateTime @default(now())
  lampiran   String?  @db.Text // URL or base64 for external resources
  
  // File storage fields (untuk file yang diupload)
  fileData       Bytes?   // Binary file data stored in database
  fileName       String?  // Original filename
  fileType       String?  // MIME type
  fileSize       Int?     // File size in bytes

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([tgl_unggah])
}

model Asesmen {
  id             String          @id @default(cuid())
  nama           String
  deskripsi      String?
  tipe           TipeAsesmen     @default(KUIS)
  tipePengerjaan TipePengerjaan? // Hanya untuk TUGAS, nullable untuk KUIS
  jml_soal       Int?            // Optional - untuk KUIS akan dihitung otomatis dari jumlah soal
  durasi         Int?            // Optional - untuk KUIS akan diisi jika ada waktu
  tgl_mulai      DateTime?
  tgl_selesai    DateTime?
  lampiran       String?         @db.Text // URL or base64 for file attachment

  // File storage fields (untuk file yang diupload)
  fileData       Bytes?   // Binary file data stored in database
  fileName       String?  // Original filename
  fileType       String?  // MIME type
  fileSize       Int?     // File size in bytes

  guruId String
  guru   User   @relation(fields: [guruId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  soal Soal[]

  nilai             Nilai[]
  pengumpulanProyek PengumpulanProyek[] // Renamed from pengumpulanTugas

  @@index([guruId])
  @@index([courseId])
  @@index([tipe])
  @@index([tgl_mulai])
  @@index([tgl_selesai])
}

model Soal {
  id          String       @id @default(cuid())
  pertanyaan  String       @db.Text
  bobot       Int          @default(10)
  tipeJawaban TipeJawaban  @default(PILIHAN_GANDA)

  asesmenId String
  asesmen   Asesmen @relation(fields: [asesmenId], references: [id], onDelete: Cascade)

  opsi          Opsi[]
  jawabanSiswa  JawabanSiswa[]

  @@index([asesmenId])
}

model Opsi {
  id      String  @id @default(cuid())
  teks    String
  isBenar Boolean @default(false)

  soalId String
  soal   Soal   @relation(fields: [soalId], references: [id], onDelete: Cascade)

  @@index([soalId])
}

model JawabanSiswa {
  id            String   @id @default(cuid())
  jawaban       String?  @db.Text // Untuk isian atau pilihan yang dipilih
  isBenar       Boolean? // Auto-scored untuk pilihan ganda, manual untuk isian
  skorDidapat   Float?   // Skor yang didapat untuk soal ini
  tanggalJawab  DateTime @default(now())

  siswaId String
  siswa   User   @relation(fields: [siswaId], references: [id])

  soalId String
  soal   Soal   @relation(fields: [soalId], references: [id], onDelete: Cascade)

  nilaiId String?
  nilai   Nilai?  @relation(fields: [nilaiId], references: [id], onDelete: Cascade)

  @@unique([siswaId, soalId], name: "siswaId_soalId")
  @@index([siswaId])
  @@index([soalId])
  @@index([nilaiId])
}

model Nilai {
  id      String   @id @default(cuid())
  skor    Float
  tanggal DateTime @default(now())

  siswaId String
  siswa   User   @relation(fields: [siswaId], references: [id])

  asesmenId String
  asesmen   Asesmen @relation(fields: [asesmenId], references: [id])

  jawabanSiswa JawabanSiswa[]

  @@unique([siswaId, asesmenId], name: "siswaId_asesmenId")
  @@index([siswaId])
  @@index([asesmenId])
  @@index([tanggal])
}

model Proyek {
  id          String   @id @default(cuid())
  judul       String
  deskripsi   String   @db.Text
  tgl_mulai   DateTime
  tgl_selesai DateTime
  lampiran    String?
  sintaks     String[] // Array sintaks yang aktif untuk proyek ini

  // File storage fields (untuk file yang diupload)
  fileData       Bytes?   // Binary file data stored in database
  fileName       String?  // Original filename
  fileType       String?  // MIME type
  fileSize       Int?     // File size in bytes

  guruId String
  guru   User   @relation(fields: [guruId], references: [id])

  kelompok Kelompok[]

  @@index([guruId])
  @@index([tgl_mulai])
  @@index([tgl_selesai])
}

model Kelompok {
  id   String @id @default(cuid())
  nama String

  proyekId String
  proyek   Proyek @relation(fields: [proyekId], references: [id])

  anggota     AnggotaKelompok[]
  pengumpulan PengumpulanProyek[]

  @@index([proyekId])
}

model AnggotaKelompok {
  id String @id @default(cuid())

  kelompokId String
  kelompok   Kelompok @relation(fields: [kelompokId], references: [id])

  siswaId String
  siswa   User   @relation(fields: [siswaId], references: [id])

  @@index([kelompokId])
  @@index([siswaId])
}

model PengumpulanProyek {
  id         String   @id @default(cuid())
  catatan    String?  @db.Text
  sourceCode String?  @db.Text
  output     String?  @db.Text
  tgl_unggah DateTime @default(now())
  nilai      Float?

  // Fields untuk tugas individu/kelompok
  namaKelompok String? // Jika kelompok (tugas)
  ketua        String? // Nama ketua kelompok (tugas)
  anggota      String? // Nama anggota kelompok (tugas)
  fileUrl      String? @db.Text // URL or base64 for file attachment

  // Relations
  kelompokId String? // Optional: untuk proyek kelompok
  kelompok   Kelompok? @relation(fields: [kelompokId], references: [id])

  siswaId String? // Optional: untuk tugas individu, yang mengupload
  siswa   User?   @relation(fields: [siswaId], references: [id])

  asesmenId String? // Optional: untuk tugas dari asesmen
  asesmen   Asesmen? @relation(fields: [asesmenId], references: [id], onDelete: Cascade)

  profileShowcase ProfileShowcase?

  @@index([kelompokId])
  @@index([siswaId])
  @@index([asesmenId])
  @@index([tgl_unggah])
}

model ProfileShowcase {
  id             String   @id @default(cuid())
  judul          String
  deskripsi      String?  @db.Text
  nilai          Float
  tanggalDinilai DateTime @default(now())
  isPublic       Boolean  @default(true)

  siswaId String
  siswa   User   @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  pengumpulanProyekId String            @unique
  pengumpulanProyek   PengumpulanProyek @relation(fields: [pengumpulanProyekId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siswaId])
  @@index([isPublic])
  @@index([tanggalDinilai])
}

model Enrollment {
  id         String   @id @default(cuid())
  enrolledAt DateTime @default(now())
  progress   Int      @default(0)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  siswaId String
  siswa   User   @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([courseId, siswaId])
  @@index([courseId])
  @@index([siswaId])
  @@index([enrolledAt])
}
